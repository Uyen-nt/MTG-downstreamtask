# scripts/05_finetune.py
import os
import shutil
import subprocess
import glob

# === C·∫§U H√åNH ƒê∆Ø·ªúNG D·∫™N ===
DATA_DIR = "data"
PRETRAIN_DIR = "/kaggle/working/MTG-downstreamtask/gram/results/pretrain"
FINETUNE_DIR = "/kaggle/working/MTG-downstreamtask/gram/results/finetune"
REAL_SEQS = "/kaggle/working/MTG-downstreamtask/data/result/mimic3/real_mimic3.3digitICD9.seqs"
REAL_LABELS = f"{DATA_DIR}/real_mimic3.labels"
TREE = f"{DATA_DIR}/tree_mimic3"

# T·∫°o th∆∞ m·ª•c finetune
os.makedirs(FINETUNE_DIR, exist_ok=True)

# === T√åM MODEL PRETRAIN (.npz) ===
pretrain_models = glob.glob(f"{PRETRAIN_DIR}/*.npz")

if not pretrain_models:
    raise FileNotFoundError(
        f"Kh√¥ng t√¨m th·∫•y model pretrain (.npz) t·∫°i {PRETRAIN_DIR}\n"
        "H√£y ch·∫°y 04_pretrain.py tr∆∞·ªõc!"
    )

best_model = sorted(pretrain_models)[-1]  # l·∫•y model cu·ªëi (best epoch)
finetune_init = f"{FINETUNE_DIR}/pretrain_model.npz"
shutil.copy(best_model, finetune_init)
print(f"‚úÖ Loaded pre-trained weights: {best_model}")
print(f"üì¶ Copied to: {finetune_init}")

# === CH·∫†Y GRAM V·ªöI AESARA (ho·∫∑c Theano) ===
cmd = [
    "python", "model/gram.py",
    REAL_SEQS,
    REAL_LABELS,
    TREE,
    FINETUNE_DIR,
    "--embed_file", finetune_init,        # D√πng .pt l√†m embedding
    "--n_epochs", "50",
    "--batch_size", "100",
    "--rnn_size", "128",
    "--attention_size", "128",
    "--dropout_rate", "0.5",
    "--L2", "0.001",
    "--verbose"
]

print("\nFine-tuning on real MIMIC-III data...")
print("Command:", " ".join(cmd))

result = subprocess.run(cmd, check=False)

if result.returncode == 0:
    print("HO√ÄN T·∫§T FINETUNE!")
    print(f"‚Üí Model saved in: {FINETUNE_DIR}")
else:
    raise RuntimeError(f"Finetune th·∫•t b·∫°i: {result.returncode}")
